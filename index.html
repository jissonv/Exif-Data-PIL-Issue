<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Preserve exif data while resizing : work ">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Notes</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/jissonv/Exif-Data-PIL-Issue">View on GitHub</a>

          <h1 id="project_title">Notes</h1>
          <h2 id="project_tagline">work </h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/jissonv/Exif-Data-PIL-Issue/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/jissonv/Exif-Data-PIL-Issue/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>
<a id="presrve-exif-data-of-the-images-while-resizing-it-using-pil" class="anchor" href="#presrve-exif-data-of-the-images-while-resizing-it-using-pil" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Presrve exif data of the images while resizing it using PIL.</h3>

<p></p><p>In one of my project I faced an issue with the PIL library that , the image lost its exif data after resized the image using PIL<br>
</p><p>I faced it for an an android app whose back end  in python–django. When a  client uploads an image to the server, and server in turn  resizes  the images with some predefined  sizes.  I resized the image using the PIL . But after resize the image losts its exif data. Client needs the exif data to layout the image.</p>

<h3>
<a id="how-i-solved-the-issue" class="anchor" href="#how-i-solved-the-issue" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How I solved the issue:</h3>

<ul>
<li>Insall gexiv2.<br>
</li>
<li>Resistrict image uploading only through TemporaryFileUploadHandler.<br>
</li>
<li>Create a temp Folder in Server - to save the resize image temporarily.<br>
</li>
<li>copy the exif data of the orignal image to the resized image using gexiv2 liberary.<br>
</li>
</ul>

<h3>
<a id="steps-in-detail" class="anchor" href="#steps-in-detail" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Steps in detail:</h3>

<p>For building and installing gexiv2 refer <a href="https://wiki.gnome.org/Projects/gexiv2/BuildingAndInstalling">gexiv2</a></p>

<h3>
<a id="how-to-do-image-upload-only-via-temporaryfileuploadhandler" class="anchor" href="#how-to-do-image-upload-only-via-temporaryfileuploadhandler" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to do image upload only via TemporaryFileUploadHandler:</h3>

<p>Edit the settings.py file as follows (django1.4)</p>

<p>FILE_UPLOAD_HANDLERS = (<br>
    'django.core.files.uploadhandler.TemporaryFileUploadHandler',<br>
)<br></p>

<h3>
<a id="procedure" class="anchor" href="#procedure" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Procedure</h3>

<ul> 
<li>get the image file and file_path
</li>
<li> get the image name and extension
</li>
<li> open image using PIL
</li>
<li> get exif data of the orginal image using gexiv2
</li>
<li> resize the image
</li>
<li> Save the resized image to temp folder
</li>
<li> Copy the exif data of the orignal image to resized
</li>
<li> save image to s3
</li>
<li> remove the resized image form temp folder
</li>
</ul>

<h3>
<a id="sample-code" class="anchor" href="#sample-code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Sample Code</h3>

<p></p><p>
From PIL import Image<br></p>

<p>Image_file =  request.FILES[‘image’]# get image from request (piston I used)<br>
file_path = image_file. temporary_file_path() #all images have file path since we upload image only through TemporaryFileUploadHandler<br>
sent_image_name = image_file.name<br>
file_extension = sent_image_name.rsplit('.', 1)[-1]<br>
file_name = ….+ '.' + file_extension<br></p>

<p>if file_extension in ('jpg', 'JPG'):<br>
            file_save_extension = 'JPEG'<br>
        else:<br>
            file_save_extension = file_extension<br></p>

<p>temp_image_path = CONFIG['resize_image_folder'] <br>
file_path = imageFile.temporary_file_path()<br></p>

<p>im = Image.open(file_path) # open the image using PIL and save it to the temp dir<br> 
exif = GExiv2.Metadata(file_path)<br>
im.thumbnail(thumbnail_size, Image.ANTIALIAS)<br>
if file_extension in ('jpg', 'JPG' , 'jpeg', 'JPEG') and im.mode == 'RGB':<br>
     resized_image_ = temp_image_path +  str(<br>
                                             thumbnail_size[0]) + '<em>' + file_name<br>
     im.save(resized_image</em>, file_save_extension)<br>
     self.set_exif_to_temp_image(exif, resized_image_,<br>
                                                    im.size[0], im.size[1]) # save resized img to temp<br></p>

<p>// store the image to some image store using image location resized_image_<br>
// finally remove the temp image
os.remove(resized_image_name)</p>

<p></p><p><br>
def set_exif_to_temp_image(self, exif, resized_image_name,x_dim, y_dim):<br><br>
        # get exif of the resized image<br>
        newExif = GExiv2.Metadata(resized_image_name)<br>
        # save the exif data of orginal image to newExif<br>
        for tag in exif.get_exif_tags():<br>
        newExif[tag] = exif[tag]<br>
        newExif['Exif.Photo.PixelXDimension'] = str(x_dim)#update some exif data of the resized image<br>
        newExif['Exif.Photo.PixelYDimension'] = str(y_dim)<br>
        try:<br>
        newExif.save_file()<br>
        except Exception:<br>
        logger.exception('Error in save exif data')<br></p>

<h3>
<a id="support-or-contact" class="anchor" href="#support-or-contact" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support or Contact</h3>

<p>Having trouble email <a href="mailto:jissonv@gmail.com">jissonv@gmail.com</a></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Notes maintained by <a href="https://github.com/jissonv">jissonv</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
